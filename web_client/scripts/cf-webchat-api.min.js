/*!
 * CommFort WebChat JS API v0.1
 * http://webcf.ru/
 *
 * Copyright 2011, Paul Annekov
 * This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License. 
 * To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-nd/3.0/ or send a letter 
 * to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.
 *
 */
function CommFortWebchat(g,e){var f=null;var d=b(g);if(d){console.log("CommFort WebChat load error: '"+d+"'");return}var c=this;this.settings={applicationName:"Web Interface v0.1",loadImages:true,maxMessageLength:20000,language:"en",proxyUrl:"/gateway?server=",channelUsers:{position:"inside",width:200,height:400}};a(e);this.server=g;this.requestPrefix='{"jsonrpc": "2.0",';this.currentID=0;this.connectID=0;this.authState=0;this.myName="";this.$channelsList=null;this.$channelsUsersList=null;this.authStatesTexts={10:"Too much users online",11:"Nick is out of rules",12:"You are banned",13:"Nick includes bad words",14:"Nick is already registered",15:"Too much users from IP",16:"Activation request sent",17:"Wrong password",18:"Activation request denied or in progress"};this.translation={ru:{Channels:"Каналы",Name:"Название",Users:"Пользователи",Topic:"Тема","No topic":"Нет темы","Users online":"Пользователей",Hidden:"Недоступен","Server is offline":"Сервер недоступен","Loading image":"Загрузка изображения","Login incorrect":"Недопустимый логин","Password incorrect":"Недопустимый пароль","Sending request to server":"Отправляю запрос серверу","Empty login or password":"Поле логина или пароля не заполнено","Sex incorrect":"Недопустимый пол","Message is empty":"Поле для ввода сообщения пустое","Too long message. Maximum length is":"Сообщение слишком длинное. Максимальная длинна:",Authorization:"Авторизация","Waiting for server response to authorization request":"Ожидание ответа на запрос авторизации","Another user has connected using your name and password":"Другой пользователь подключился используя Ваше имя и пароль","Too much users online":"Превышено максимальное число подключенных пользователей","Nick is out of rules":"Имя не соответствует требованиям (содержит служебные символы, либо превышает максимальную длину в 40 символов)","You are banned":"Для данного пользователя доступ к серверу запрещен (бан)","Nick includes bad words":"Имя содержит запрещенные слова (не проходит фильтр плохих слов)","Nick is already registered":"Схожее по написанию имя уже зарегистрировано","Too much users from IP":"Превышено максимальное число учетных записей с данного IP-адреса","Activation request sended":"Заявка на активацию успешно отправлена","Wrong password":"Неверный пароль","Activation request denied or in progress":"Заявка на активацию не обработана, либо отклонена"}};function a(h){f.extend(true,c.settings,h)}function b(h){if(typeof jQuery=="undefined"){return"jQuery framework script not found"}else{if(jQuery!=f){f=jQuery}}if(!f.hasOwnProperty("ui")){return"jQuery UI script not found"}if(!f.ui.hasOwnProperty("dialog")){return"jQuery UI Dialog component not found"}if(!f.ui.hasOwnProperty("sortable")){return"jQuery UI Sortable component not found"}if(!f.ui.hasOwnProperty("draggable")){return"jQuery UI Draggable component not found"}if(!f.ui.hasOwnProperty("droppable")){return"jQuery UI Droppable component not found"}if(!f.fn.hasOwnProperty("qtip")){return"jQuery qTip component not found"}if(!h){return"Server is not valid"}return false}this.parseError=function(h){console.log(h);this.error={};if(h.code!=undefined){alert(h.code+": "+h.message+" ("+h.data+")");this.error.code=h.code}else{alert(h);this.error.code=100;this.error.message=h.message}};this.parseResponseError=function(h){switch(h.code){case -32602:this.dom.showGlobalNotification(this.t("Previous connection closed. Reconnecting..."),"notice");this.methods.connectionInit();break}};this.resetID=function(){this.currentID=0};this.addCurrentID=function(){return(this.currentID)++};this.buildParameters=function(l,k,h){var i=this.requestPrefix;i+='"method":"'+l+'", ';i+='"params":';if(typeof k=="string"){i+=this.getJSONValue(k)}else{i+="{";if(this.connectID!==0){i+='"conn_id":"'+this.connectID+'",'}for(var j in k){if(k.hasOwnProperty(j)){i+=(k[j].type)?this.getVariableDefinition(j,k[j].value,false,"plain"):this.getVariableDefinition(j,k[j])}}i=i.substr(0,i.length-1)+"}"}if(typeof h=="undefined"||!h){i+=', "id":'+this.addCurrentID()}i+="}";return i};this.getJSONValue=function(i,h){return(h!="plain")?'"'+encodeURI(i)+'"':i};this.getVariableDefinition=function(i,k,l,j){var h='"'+i+'":'+this.getJSONValue(k,j);if(!l){h+=","}return h};this.sendRequest=function(i,j,l,h,k){f.post(this.settings.proxyUrl+this.server,i,function(m){if(typeof l!="undefined"){c[j][l](m,k)}}).error(function(m){if(m.status!=502){c.dom.showGlobalNotification(c.t("Server is offline"),"error",false)}if(typeof h!="undefined"){c[j][l]({error:m.status})}})};this.t=function(h){if(c.settings.language!="en"&&c.translation[c.settings.language].hasOwnProperty(h)){h=c.translation[c.settings.language][h]}return h};this.updateChannelsUsersCounter=function(){for(var j in this.channels){if(this.channels.hasOwnProperty(j)&&this.channels[j].active){var i=0;for(var h in this.users){if(this.users.hasOwnProperty(h)&&typeof this.getArrayIndex(this.users[h].channels,"name",this.channels[j].name)!=undefined){i++}}this.channels[j].usersOnline=i;this.dom.updateChannelUsersListCounter(this.channels[j].usersList,i);this.dom.updateChannelTabCounter(this.channels[j].tab,i)}}};this.removeActiveChannels=function(h){this.dom.removeActiveChannel(this.channels[h]);delete this.channels[h].tab;delete this.channels[h].messagesArea;delete this.channels[h].usersList;this.channels[h].active=false;this.channels[h].current=false};this.updateChannel=function(j,i,l,m){var k=this.getArrayIndex(this.channels,"name",j);if(typeof k!=undefined){this.channels[k].topic=i;this.channels[k].greeting=l;this.channels[k].active=true;this.channels[k].usersOnline=m.length}else{this.channels.push({name:j,topic:i,greeting:l,usersOnline:m.length,active:true});k=this.getArrayIndex(this.channels,"name",j)}this.dom.addActiveChannel(k);for(var h in m){if(m.hasOwnProperty(h)){this.addUserToChannel(m[h],this.channels[k])}}};this.addUserToChannel=function(h,j){var i=this.getArrayIndex(this.users,"name",h);this.users[i].channels.push({name:j.name,listElem:this.dom.addUserToChannel(j.usersList,this.users[i])})};this.htmlGenerators={parent:this,channelList:function(i,j){var h=(i.topic)?c.escapeHtml(i.topic):"";if(j){j=' class="cfw-active-channel"'}else{j=""}return"<tr"+j+"><td>"+c.escapeHtml(i.name)+"</td><td>"+i.usersOnline+"</td><td>"+h+"</td></tr>"},channelMessage:function(i,j,l,k){var h='<div class="cfw-message"><div class="cfw-sender">'+c.escapeHtml(i)+"</div>: ";if(!k){h+=c.escapeHtml(j)}else{if(c.settings.loadImages){h+='<div class="cfw-loading-image">'+c.t("Loading image")+"...</div>"}else{h+='<div class="cfw-load-image">'+c.t("Click to load image")+"</div>"}}h+="</div>";return h},image:function(h){return'<div class="cfw-image"><img src="data:image/jpeg;base64,'+h+'" /></div>'}};this.joinChannel=function(h){if(this.getArrayElem(this.users,"iAm",true).channels.length<16){this.methods.channelConnect(this.channels[h].name)}else{this.dom.showGlobalNotification(this.t("Too much active channels. User can\t access more then 16 channels"),"warning")}};this.getCurrentChannelName=function(){var h=this.getArrayElem(this.channels,"current",true);return h.name};this.setCurrentChannel=function(h){var i=this.getArrayIndex(this.channels,"current",true);if(typeof i!="undefined"){this.channels[i].current=false}this.channels[h].current=true;this.dom.setCurrentChannel(this.channels[h])};this.setCurrentUser=function(h){this.users[this.getArrayIndex(this.users,"name",h)].iAm=true};this.getArrayIndex=function(l,j,i){var h;for(var k in l){if(l.hasOwnProperty(k)&&l[k][j]==i){h=k;break}}return h};this.getArrayElem=function(l,k,j){var h;var i=this.getArrayIndex(l,k,j);if(i>=0){h=l[i]}return h};this.cookie={setCookie:function(i,k,m,j,h,l){if(!i){return false}var n=i+"="+encodeURIComponent(k);if(h){n+="; expires="+h.toGMTString()}if(m){n+="; path="+m}if(j){n+="; domain="+j}if(l){n+="; secure"}document.cookie=n;return true},getCookie:function(h){var j="(?:; )?"+h+"=([^;]*);?";var i=new RegExp(j);if(i.test(document.cookie)){return decodeURIComponent(RegExp["$1"])}return false},deleteCookie:function(h){this.setCookie(h,"",null,null,new Date(0));return true}};this.escapeHtml=function(h){if(typeof h!="undefined"&&h!=null&&h.length>0){h=h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}else{h=""}return h};this.parseActions=function(i){if(i&&i.length>0){for(var h in i){if(i.hasOwnProperty(h)&&this.actions.hasOwnProperty(i[h].method)){this.actions[i[h].method](i[h].result)}}}};this.validate={userData:function(h){if(h.nick&&h.pass){if(h.nick.length<=0||h.nick.length>40){return c.t("Login incorrect")}if(h.pass.length<=0){return c.t("Password incorrect")}}else{return c.t("Empty login or password")}return true}};this.methods={parent:this,connectionInit:function(){return c.buildParameters("conn_init",{app_name:c.settings.applicationName})},checkConnectionID:function(h){return c.buildParameters("check_conn_id",h)},connectionClose:function(){try{var i=c.buildParameters("conn_close");c.cookie.deleteCookie("cfConnectionID");c.cookie.deleteCookie("cfUserConnected");c.sendRequest(i,"callbacks","connectionClose")}catch(h){c.parseError(h);i=undefined}return i},userConnect:function(h){return c.buildParameters("user_connect",h)},userDisconnect:function(){try{var i=c.buildParameters("user_disconnect")}catch(h){c.parseError(h);i=undefined}return i},sendPublicMess:function(k,j,m){try{if(!j){throw c.t("Message is empty")}if(j.length>c.settings.maxMessageLength){throw c.t("Too long message. Maximum length is")+" "+c.settings.maxMessageLength}var l={channel:k,message:j,mode:m};var i=c.buildParameters("send_public_mess",l);c.sendRequest(i,"callbacks","sendPublicMess")}catch(h){c.dom.showSendError(h,"error")}},getAuthState:function(){try{var i=c.buildParameters("get_auth_state");c.sendRequest(i,"callbacks","getAuthState")}catch(h){c.parseError(h);i=undefined}return i},getChnlsList:function(h){return c.buildParameters("get_chnls_list")},getActions:function(){return c.buildParameters("get_actions",null,true)},getChnlUsers:function(j){try{var k=(j?{chnl_name:j}:"");var i=c.buildParameters("get_chnl_users",k)}catch(h){c.parseError(h);i=undefined}return i},getOnlineUsers:function(){return c.buildParameters("get_online_users")},getUserChannels:function(){try{var i=c.buildParameters("get_user_channels");c.sendRequest(i,"callbacks","getUserChannels")}catch(h){c.parseError(h);i=undefined}return i},getImage:function(j,l){try{var k={image_id:j};var i=c.buildParameters("get_image",k);c.sendRequest(i,"callbacks","getImage",null,l)}catch(h){c.parseError(h);i=undefined}return i},channelConnect:function(k,m,h){try{var l={};l.channel=k;if(typeof m!="undefined"){l.visible=m}if(typeof h!="undefined"){l.enter_type=h}var j=c.buildParameters("channel_connect",l);c.sendRequest(j,"callbacks","channelConnect")}catch(i){c.parseError(i)}},channelDisconnect:function(j){try{var i=c.buildParameters("channel_disconnect",{channel:j});c.sendRequest(i,"callbacks","channelDisconnect")}catch(h){c.parseError(h)}},getOwnUserName:function(){try{var i=c.buildParameters("get_own_user_name");c.sendRequest(i,"callbacks","getOwnUserName")}catch(h){c.parseError(h)}}};this.callbacks={parent:this,connectionClose:function(h){if(!h.hasOwnProperty("error")){c.connectID=0;c.sendRequest("getAuthState")}else{c.parseError(h.error)}},userRegister:function(h){if(!h.hasOwnProperty("error")){c.cookie.setCookie("cfUserConnected",true);c.sendRequest("userConnect",{nick:c.nick,pass:c.pass})}else{c.parseError(h.error)}},userDisconnect:function(h){if(!h.hasOwnProperty("error")){c.sendRequest("getAuthState")}else{c.parseError(h.error)}},sendPublicMess:function(h){if(!h.hasOwnProperty("error")){}else{c.parseError(h.error)}},getAuthState:function(h){if(!h.hasOwnProperty("error")){var i=c.checkAuthState(h.result);if(i){c.methods.getAuthState()}}else{c.parseError(h.error)}},getChnlsList:function(h){if(!h.hasOwnProperty("error")){c.channels=[];for(var i in h.result){if(h.result.hasOwnProperty(i)){c.channels.push({name:h.result[i].name,topic:h.result[i].topic,usersOnline:h.result[i].users_online,access:h.result[i].access})}}c.methods.getOnlineUsers()}else{c.parseError(h.error)}},getActions:function(h){if(!h.hasOwnProperty("error")){if(h.method=="get_actions"){c.parseActions(h.result)}else{if(c.actions.hasOwnProperty(h.method)){c.actions[h.method](h.result)}}if(c.authState!=6){setTimeout(function(){c.methods.getActions()},2000)}}else{if(h.error.code==105){setTimeout(function(){c.methods.getActions()},2000)}else{c.parseError(h.error)}}},getActionsAuthState:function(i){if(!i.hasOwnProperty("error")){var j=true;if(!c.hasOwnProperty("tmpActions")){c.tmpActions=[]}if(i.method!="get_actions"){i.result={method:i.method,result:i.result}}for(var h in i.result){if(i.result[h].method=="user_auth_state"){j=c.actions[i.result[h].method](i.result[h].result)}else{c.tmpActions.push(i.result[h])}}if(j){c.methods.getActions("getActionsAuthState")}}else{c.parseResponseError(i.error)}},getChnlUsers:function(h){if(!h.hasOwnProperty("error")){alert(h)}else{c.parseError(h.error)}},getOnlineUsers:function(h){if(!h.hasOwnProperty("error")){c.users=[];for(var i in h.result){h.result[i].channels=[];c.users.push(h.result[i])}c.setCurrentUser(c.myName);delete c.myName;c.chatDataLoaded=true;c.parseActions(c.tmpActions);delete c.tmpActions;c.methods.getActions()}else{c.parseError(h.error)}},getUserChannels:function(i){if(!i.hasOwnProperty("error")){for(var j in i.result){var h=c.getArrayIndex(c.channels,"name",i.result[j]);c.channels[h].active=true}c.getInitChatData()}else{c.parseError(i.error)}},getImage:function(h,i){if(!h.hasOwnProperty("error")){c.dom.addMessageImage(c.htmlGenerators.image(h.result),i)}else{c.parseError(h.error)}},channelConnect:function(h){if(!h.hasOwnProperty("error")){}else{c.parseError(h.error)}},channelDisconnect:function(h){if(!h.hasOwnProperty("error")){}else{c.parseError(h.error)}},getOwnUserName:function(h){if(!h.hasOwnProperty("error")){c.setCurrentUser(h.result);c.chatDataLoaded=true;c.methods.getActions()}else{c.parseError(h.error)}}};this.actions={parent:this,user_auth_state:function(h){if(h!=c.authState){c.authState=h;if(c.authState!=0){if(c.authState==7||c.authState==6){c.cookie.deleteCookie("cfUserConnected");c.dom.showAuthForm();c.dom.showNotification("auth",c.t("Another user has connected using your name and password"),"warning",false)}else{if(c.authState==8){c.dom.authState(c.t("Waiting for server response to authorization request"))}else{if(c.authState==9){c.dom.authState(c.t("In chat"));c.dom.authSuccess()}else{if(c.authState>9){c.cookie.deleteCookie("cfUserConnected");c.dom.showAuthForm();c.dom.authUnsuccess();c.dom.showAuthError(c.t(c.authStatesTexts[c.authState]))}}}}}}},public_mess:function(j){var h=c.htmlGenerators.channelMessage(j.sender,j.message,j.mode,j.image);var i=c.getArrayElem(c.channels,"name",j.channel);if(i){var k=c.dom.insertMessage(i.messagesArea,h);if(k&&j.image){c.methods.getImage(j.image,k)}}},virtual_user_channel_connect:function(h){c.updateChannel(h.channel,h.topic,h.greeting,h.users)},user_channel_connect:function(h){console.log(h)},user_channel_disconnect:function(i){var h=c.getArrayElem(c.users,"name",i.user)},user_disconnect:function(h){},user_connect:function(h){c.users.push(h.result)}};this.dom={parent:this,showNotification:function(k,j,i,h){i=(typeof(i)!="undefined")?i:"error";h=(typeof(h)!="undefined")?h:true;f("#cfw-chat .cfw-"+k+"-notifications").stop(true,true).removeClass("cfw-error cfw-notice cfw-warning").html(j).addClass("cfw-"+i).css("display","").removeClass("cfw-hidden");if(h){this.hideNotification(k,false)}},hideNotification:function(j,h){var i=(typeof(h)=="undefined"||h)?0:1000;f("#cfw-chat .cfw-"+j+"-notifications").delay(i).fadeOut(2000,function(){f("#cfw-chat .cfw-"+j+"-notifications").addClass("cfw-hidden")})},showGlobalNotification:function(j,i,h){this.showNotification("global",j,i,h)},hideGlobalNotification:function(){this.hideNotification("global")},showAuthError:function(j,i,h){this.showNotification("auth",j,i,h)},showSendError:function(j,i,h){this.showNotification("send",j,i,h)},showAuthForm:function(){f("#cfw-chat .cfw-login-form input").removeAttr("disabled");f("#cfw-chat .cfw-auth-state").addClass("cfw-hidden");f("#cfw-chat .cfw-chat-area").addClass("cfw-hidden");f("#cfw-chat .cfw-login-form").removeClass("cfw-hidden")},showChat:function(){f("#cfw-chat .cfw-chat-area").removeClass("cfw-hidden")},authProcess:function(){f("#cfw-chat .cfw-login-form input").attr("disabled","disabled");f("#cfw-chat .cfw-auth-notifications").addClass("cfw-hidden");f("#cfw-chat .cfw-auth-state").removeClass("cfw-hidden")},authSuccess:function(){f("#cfw-chat .cfw-login-form").addClass("cfw-hidden");f("#cfw-chat .cfw-auth-state").addClass("cfw-hidden");this.showChat()},initUI:function(){this.clearUI();var i='<div class="cfw-channels-list"><table><thead><tr><td>'+c.t("Name")+"</td><td>"+c.t("Users")+"</td><td>"+c.t("Topic")+"</td></tr></thead><tbody></tbody></table></div>";this.$channelsList=f(i).dialog({autoOpen:false,title:c.t("Channels"),modal:true,width:400,height:300});f(".cfw-channels-tabs").sortable({axis:"x"});f(".cfw-channels-tabs").disableSelection();var h='<div class="cfw-channels-users" style="width: '+c.settings.channelUsers.width+'"></div>';if(c.settings.channelUsers.position=="inside"){c.$channelsUsersList=f(h).insertBefore(".cfw-channels-and-users .cfw-clear");f(".cfw-channels").css("margin-left","-"+c.settings.channelUsers.width+"px");f(".cfw-channels-wrapper").css("padding-left",c.settings.channelUsers.width+"px");c.$channelsUsersList.addClass("cfw-channels-users-inside");f(".cfw-channels-wrapper").addClass("cfw-channels-two-columns")}else{var j;if(c.settings.channelUsers.anchor){j=f(c.settings.channelUsers.anchor).offset()}else{j=f("#cfw-chat").offset()}c.$channelsUsersList=f(h).appendTo("body");c.$channelsUsersList.css({position:"absolute",top:j.top,left:j.left});c.$channelsUsersList.draggable({containment:"window",snap:".cfw-chat-area, body",snapTolerance:15,handle:".cfw-channel-users-head"});c.$channelsUsersList.addClass("cfw-channels-users-outside")}},clearUI:function(){f("#cfw-chat .cfw-channels-tabs .cfw-channel-tab").remove();f("#cfw-chat .cfw-channels").empty();c.$channelsList&&c.$channelsList.remove();c.$channelsUsersList&&c.$channelsUsersList.remove()},authUnsuccess:function(){f("#cfw-chat .cfw-login-form input").removeAttr("disabled");f("#cfw-chat .cfw-auth-state").addClass("cfw-hidden")},authState:function(h){f("#cfw-chat .cfw-auth-state").text(h+"...")},insertMessage:function(h,i){var j=f(i).appendTo(f(".cfw-messages-list",h));return j.get(0)},addActiveChannel:function(k){var j=c.channels[k];var m=(j.current)?" cfw-current":"";var h=(j.topic)?c.escapeHtml(j.topic):c.t("No topic");var i='				<div class="cfw-channel-tab'+m+'">					<div class="cfw-channel-tab-name">'+c.escapeHtml(j.name)+'</div>					<div class="cfw-channel-tab-counter">['+j.usersOnline+']</div>					<div class="cfw-channel-tab-close"></div>				</div>';var n='<div class="cfw-channel'+m+'"><div class="cfw-channel-topic">'+h+'</div><div class="cfw-messages-list"></div></div>';var l=' 				<div class="cfw-channel-users-list'+m+'"> 					<div class="cfw-channel-users-head">'+c.t("Users online")+': <span class="cfw-users-counter">'+j.usersOnline+"</span></div> 					<ul></ul> 				</div>";c.channels[k].tab=f(i).appendTo("#cfw-chat .cfw-channels-tabs").get(0);c.channels[k].messagesArea=f(n).appendTo("#cfw-chat .cfw-channels").get(0);c.channels[k].usersList=f(l).appendTo(c.$channelsUsersList).get(0);c.setCurrentChannel(k)},updateChannelTabCounter:function(i,h){f(".cfw-channel-tab-counter",i).text("["+h+"]")},addMessageImage:function(h,i){f(".cfw-loading-image",i).remove();f(i).append(h)},showChannelsList:function(){f("#cfw-chat .cfw-channels-list").removeClass("cfw-hidden")},addUserToChannel:function(l,h){var j=(h.sex)?"female":"male";var m=(h.ip=="N/A")?c.t("Hidden"):h.ip;var k=(h.state!=null)?" ["+c.escapeHtml(h.state)+"]":"";var i=' 				<li class="cfw-user cfw-'+j+'">'+c.escapeHtml(h.name)+'<span class="cfw-user-state">'+k+"</span> 				</li>";var n=f(i).appendTo(f("ul",l));n.mouseover(function(){c.dom.showUserInfoTip(this,h.name)});return n.get(0)},showUserInfoTip:function(j,i){var h=c.getArrayElem(c.users,"name",i);if(typeof h!="undefined"){f(j).qtip({content:h.ip+" "+h.sex,position:{my:"right center",at:"left center",target:f(j),viewport:f(window)}})}},removeActiveChannel:function(h){if(h.current==true){var i=f(h.tab).prev(".cfw-channel-tab");if(!i.length){i=f(h.tab).next(".cfw-channel-tab")}if(i.length){c.setCurrentChannel(c.getArrayIndex(c.channels,"tab",i.get(0)))}}f(h.tab).remove();f(h.messagesArea).remove();f(h.usersList).remove()},updateChannelUsersListCounter:function(i,h){f(".cfw-users-counter",i).text(h)},addChannel:function(i){var h=f(i).appendTo(f("table tbody",c.$channelsList.dialog("widget")));return h.get(0)},setCurrentChannel:function(h){f(".cfw-channel-tab.cfw-current").removeClass("cfw-current");f(h.tab).addClass("cfw-current");f(".cfw-channel.cfw-current").removeClass("cfw-current");f(h.messagesArea).addClass("cfw-current");f(".cfw-channel-users-list.cfw-current").removeClass("cfw-current");f(h.usersList).addClass("cfw-current")}};this.init={connectionInit:function(){if(c.cookie.getCookie("cfConnectionID")&&!c.cookie.getCookie("cfUserConnected")){c.sendRequest(c.methods.checkConnectionID(c.cookie.getCookie("cfConnectionID")),"init","checkConnection")}else{c.sendRequest(c.methods.connectionInit(),"init","connectionInitiated")}},checkConnection:function(h){if(h.result){c.connectID=c.cookie.getCookie("cfConnectionID");c.dom.showAuthForm()}else{c.sendRequest(c.methods.connectionInit(),"init","connectionInitiated")}},connectionInitiated:function(h){if(!h.hasOwnProperty("error")){c.cookie.setCookie("cfConnectionID",h.result.conn_id);c.cookie.deleteCookie("cfUserConnected");c.connectID=h.result.conn_id;c.dom.hideGlobalNotification();c.dom.showAuthForm()}else{c.dom.showGlobalNotification(h.error.message,"error",false)}},userConnect:function(h){var i=c.validate.userData(h);if(i){h.pass=f.md5(h.pass);c.sendRequest(c.methods.userConnect(h),"init","userConnected");c.dom.authState(c.t("Sending request to server"));c.dom.authProcess();c.myName=h.nick}else{c.dom.showAuthError(i,"error",true)}},userConnected:function(h){if(!h.hasOwnProperty("error")){c.cookie.setCookie("cfUserConnected",true);c.dom.initUI();c.dom.authState(c.t("Authorization"));c.sendRequest(c.methods.getActions(),"init","userConnectProcess",true)}else{c.dom.showAuthError(h.error)}},userConnectProcess:function(i){var j=true;if(!i.hasOwnProperty("error")){if(!c.hasOwnProperty("tmpActions")){c.tmpActions=[]}if(i.method!="get_actions"){i.result={method:i.method,result:i.result}}for(var h in i.result){if(i.result[h].method=="user_auth_state"){j=c.actions[i.result[h].method](i.result[h].result)}else{c.tmpActions.push(i.result[h])}}}if(c.authState==8||c.authState==0||i.error==502){c.sendRequest(c.methods.getActions(),"init","userConnectProcess",true)}else{if(c.authState==9){c.sendRequest(c.methods.getChnlsList(),"init","getChannelsList")}}},getChannelsList:function(h){if(!h.hasOwnProperty("error")){c.channels=[];for(var i in h.result){if(h.result.hasOwnProperty(i)){c.channels.push({name:h.result[i].name,topic:h.result[i].topic,usersOnline:h.result[i].users_online,access:h.result[i].access})}}c.sendRequest(c.methods.getOnlineUsers(),"init","getOnlineUsers")}},getOnlineUsers:function(h){if(!h.hasOwnProperty("error")){c.users=[];for(var i in h.result){h.result[i].channels=[];c.users.push(h.result[i])}c.setCurrentUser(c.myName);delete c.myName;c.chatDataLoaded=true;c.parseActions(c.tmpActions);delete c.tmpActions;c.sendRequest(c.methods.getActions(),"init","getActions",true)}},getActions:function(h){if(!h.hasOwnProperty("error")){if(h.method=="get_actions"){c.parseActions(h.result)}else{if(c.actions.hasOwnProperty(h.method)){c.actions[h.method](h.result)}}}(c.authState!=6||h.error==502)&&setTimeout(function(){c.sendRequest(c.methods.getActions(),"init","getActions",true)},2000)}};f("#cfw-chat .cfw-join-channel").click(function(){var l=f("table tbody",c.$channelsList.dialog("widget"));l.empty();for(var k in c.channels){var j=c.channels[k];var i="			<tr"+((j.active)?' class="cfw-active-channel"':"")+">				<td>"+c.escapeHtml(j.name)+"</td>				<td>"+j.usersOnline+"</td>				<td>"+c.escapeHtml(j.topic)+"</td>			</tr>";var h=f(i).appendTo(l);if(!j.active){(function(m){h.click(function(){c.$channelsList.dialog("close");c.joinChannel(m)})})(k)}}c.$channelsList.dialog("option","width","auto");c.$channelsList.dialog("option","height","auto");c.$channelsList.dialog("open")});f(".cfw-channels-users").delegate(".cfw-channel-users-list .cfw-user-name","hover",function(){});f("#cfw-chat .cfw-send-button").click(function(){c.methods.sendPublicMess(c.getCurrentChannelName(),f("#cfw-chat .cfw-message-area").val(),0);f("#cfw-chat .cfw-message-area").val("")});f("#cfw-chat .cfw-channel-tab-close").live("click",function(h){c.methods.channelDisconnect(c.getArrayElem(c.channels,"tab",f(this).parent().get(0)).name);c.removeActiveChannels(c.getArrayIndex(c.channels,"tab",f(this).parent().get(0)));h.stopPropagation()});f("#cfw-chat .cfw-channel-tab:not(.cfw-current)").live("click",function(){c.setCurrentChannel(c.getArrayIndex(c.channels,"tab",this))});f("li.cfw-user").live("mouseover",function(){});f("#cfw-chat .cfw-login-form form").submit(function(){c.init.userConnect({nick:f("#cfw-chat .cfw-login-form .cfw-login").attr("value"),pass:f("#cfw-chat .cfw-login-form .cfw-password").attr("value")});return false});this.init.connectionInit()};