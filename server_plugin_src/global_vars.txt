channels
	name
	users
	
virtual_users
	name
	channels
	
ChannelsUsers
	user=channel
	
http_connections, socket_connections
	sd
	*in_buffer
	*out_buffer
	in_buf_length
	out_buf_length
	json_length
	json_length_received
	ip
	
logical_connections
	sock
	conn_id
	app_name
	ip
	virtual_user
	auth_status
	time
	last_act_t
----------------------------------------
users
	name
	comp_id
	ip
	sex
online_users
	user_reference
	state
	client_version
	process
	active
	delay
user_channel
	user_reference
	channel_reference
auth_queue
	connection_reference
	user_name
channels
	name
	topic
	topic_editor
	topic_date
	topic_edit
	greeting
	images_type
	visibility
	enter
channels_watchers
	user_reference
	channel_reference
----------------------------------------	
Прием событий от сервера
	1090 Авторизация виртуального пользователя невозможна
		1. Найти в auth_queue пользователя.
		2. Установить соответствующий статус соединению.
		3. Удалить пользователя из auth_queue.
	1078 Вход в чат 
		1. Ищем пользователя в users, добавляем его в online_users, обновляем информацию о нем.
		2. Ищем пользователя в auth_queue. Если нашли:
			2.1 Устанавливаем соединению соответствующий статус.
			2.2 Добавляем соответствие в user_connection.
			2.3 Удаляем пользователя из auth_queue.
	1079 Выход из чата
		1. Ищем пользователя в online_users.
		2. Ищем пользователя в user_connection. Если нашли:
			2.1 Устанавливаем соединению статус атворизации.
			2.2 Удаляем все записи пользователя в user_channel.
			2.3 Проверяем не отслеживал ли пользователь какие-либо каналы в channels_watchers и, если отслеживал, то устанавливаем других пользователей на отслеживание или вообще удаляем запись о слежке, если канал больше не обслуживается.
			2.4 Удаляем запись в user_connection.
		3. Удаляем пользователя из online_users.
	1062 Подключение к каналу виртуального пользователя
		1. Ищем соединение этого пользователя в logical_connections.
		2. Ищем запись в channels_watchers не отслеживает ли этот канал кто-либо. Если никто не отслеживает:
			2.1 Устанавливаем этого пользователя как отслеживающего.
			2.2 Запрашиваем полную информацию о канале и обновляем соответствующую запись в channels.
			2.3 Запрашиваем список пользователей канала и через поиск каждого пользователя в online_users добавляем записи в user_channel.
                3. Добавляем пользователя в user_channel.
		4. Отсылаем соединению уведомление о событии.
	1091 Подключение к каналу виртуального пользователя невозможно
		1. Ищем соединение этого пользователя в user_connection.
		2. Отсылаем соединению уведомление о событии.
	1072 Подключение к каналу стороннего пользователя
		1. Проверяем является ли этот пользователь отслеживающим канал. Если является:
			1.1 Добавляем пользователя в таблицу user_channel.
			1.2 Отсылаем уведомление о событии всем соединениям, чьи пользователи находятся в этом канале.
	1073 Отключение от канала стороннего или виртуального пользователя
		1. Проверяем является ли этот пользователь отслеживающим канал. Если является:
			1.1 Удаляем пользователя из таблицы user_channel.
			1.2 Отсылаем уведомление о событии всем соединениям, чьи пользователи находятся в этом канале.
	1077 Изменение состояния пользователя
		1. Отсылаем уведомление о событии всем соединениям.
	1076 Изменение иконки пользователя
		1. Отсылаем уведомление о событии всем соединениям.
	1070 Публикация в общий канал
		1. Проверяем является ли этот пользователь отслеживающим канал. Если является:
			1.1 Отсылаем уведомление о событии всем соединениям, чьи пользователи находятся в этом канале.
	1060 Публикация в приватный канал
		1. Отсылаем уведомление о событии соединению виртуального пользователя.
	1061 Личное сообщение
		1. Отсылаем уведомление о событии соединению виртуального пользователя.
	1071 Изменение темы
		1. Проверяем является ли этот пользователь отслеживающим канал. Если является:
			1.1 Изменяем тему канала, ник пользователя, изменившего тему и дату изменения для записи в channels.
			1.2 Отсылаем уведомление о событии всем соединениям, чьи пользователи находятся в этом канале.
	1081 Регистрация новой учетной записи
		1. Добавляем в users новую запись.
		2. Отсылаем уведомление о событии всем соединениям.
----------------------------------------
Технология отслеживания каналов
За каждым каналом закреплен пользователь, который его отслеживает. При поступлении события в канале оно обрабатывается только отслеживающим пользователем.
Процесс:
1. Поиск пользователя по нику, который отслеживает данный канал.
2. Если не найден - устанавливаем данного пользователя, как отслеживающего.
3. Найти всех виртуальных пользователей этого канала и отправить им уведомление о событии.
Преимущества:
1. В случае с картинками не нужно генерировать для каждого пользователя одно и тоже изображение.
2. Не нужно по несколько раз парсить двоичную строку события.
Недостатки:
1. Надо искать к каким пользователям относится это событие.
2. Нужно трепетно относиться к синхронизации действий, чтобы данные о нахождении виртуальных пользователей в каналах всегда были актуальны.
----------------------------------------
Почему не должно быть проверки регистрации пользователя при авторизации?
Потому что если пользователь подал заявку на регистрацию, потом через некоторое время регистрация одобрена, но пока пользователь не войдет первый раз в чат событие регистрации не возникнет. В итоге пользователь не сможет авторизироваться после регистрации, так как плагин будет постоянно говорить, что пользователь еще не регнут, хоть это не так.
----------------------------------------
Авторизация пользователя
1. Соединение подает запрос на авторизацию виртуального пользователя.
2. В массив очереди авторизации auth_queue добавляется ссылка на соединение и ник пользователя, для которого происходит авторизация.
3. Плагин подает серверу запрос на авторизацию.
4. При входе пользователя в чат идет проверка не находится ли он в очереди авторизации. Если находится - он удаляется из очереди и соединению ставится ссылка на этого пользователя из массива пользователей онлайн online_users.
5. Если произошла ошибка авторизации, то ищется этот пользователь в массиве, соединению устанавливается соответствующий статус авторизации и запись удаляется.